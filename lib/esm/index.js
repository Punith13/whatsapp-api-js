var g=class{constructor({token:e,appSecret:t,webhookVerifyToken:s,v:r="v16.0",parsed:n=!0,secure:o=!0,ponyfill:i={}}){this.on={};if(this.token=e,this.secure=!!o,this.secure){if(this.appSecret=t,typeof i.subtle!="object"&&(typeof crypto!="object"||typeof crypto?.subtle!="object"))throw new Error("subtle is not defined in the enviroment, please provide a valid ponyfill object with the parameter 'ponyfill.subtle'.");this.subtle=i.subtle||crypto.subtle}if(s&&(this.webhookVerifyToken=s),typeof i.fetch!="function"&&typeof fetch!="function")throw new Error("fetch is not defined in the enviroment, please provide a valid ponyfill function with the parameter 'ponyfill.fetch'.");this.fetch=i.fetch||fetch,this.v=r,this.parsed=!!n}async sendMessage(e,t,s,r){let n=s._type,o={messaging_product:"whatsapp",type:n,to:t};o[n]=s._build(),r&&(o.context={message_id:r});let i=this.fetch(`https://graph.facebook.com/${this.v}/${e}/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify(o)}),a=this.parsed?await(await i).json():void 0,p={phoneID:e,to:t,type:n,message:s,request:o,id:a&&"messages"in a?a.messages[0].id:void 0,response:a};return this.on.sent?.(p),a??i}async broadcastMessage(e,t,s,r=50,n=1e3){let o=[];if(r<1)throw new RangeError("batch_size must be greater than 0");if(n<0)throw new RangeError("delay must be greater or equal to 0");for(let i=0;i<t.length;i+=r){i!==0&&await new Promise(a=>setTimeout(a,n));for(let a of t.slice(i,i+r))o.push(this.sendMessage(e,a,s))}return o}async markAsRead(e,t){let s=this.fetch(`https://graph.facebook.com/${this.v}/${e}/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",status:"read",message_id:t})});return this.getBody(s)}async createQR(e,t,s="png"){let r=this.fetch(`https://graph.facebook.com/${this.v}/${e}/message_qrdls?generate_qr_image=${s}&prefilled_message=${t}`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`}});return this.getBody(r)}async retrieveQR(e,t){let s=this.fetch(`https://graph.facebook.com/${this.v}/${e}/message_qrdls/${t??""}`,{headers:{Authorization:`Bearer ${this.token}`}});return this.getBody(s)}async updateQR(e,t,s){let r=this.fetch(`https://graph.facebook.com/${this.v}/${e}/message_qrdls/${t}?prefilled_message=${s}`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`}});return this.getBody(r)}async deleteQR(e,t){let s=this.fetch(`https://graph.facebook.com/${this.v}/${e}/message_qrdls/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${this.token}`}});return this.getBody(s)}async retrieveMedia(e,t){let s=t?`phone_number_id=${t}`:"",r=this.fetch(`https://graph.facebook.com/${this.v}/${e}?${s}`,{headers:{Authorization:`Bearer ${this.token}`}});return this.getBody(r)}async uploadMedia(e,t,s=!0){if(s){if(!t||typeof t!="object"||!("get"in t)||typeof t.get!="function")throw new TypeError("File's Form must be an instance of FormData");let n=t.get("file");if(!n.type)throw new Error("File's Blob must have a type specified");if(!["audio/aac","audio/mp4","audio/mpeg","audio/amr","audio/ogg","text/plain","application/pdf","application/vnd.ms-powerpoint","application/msword","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/jpeg","image/png","video/mp4","video/3gp","image/webp"].includes(n.type))throw new Error(`Invalid media type: ${n.type}`);let i={audio:16e6,text:1e8,application:1e8,image:5e6,video:16e6,sticker:5e5},a=n.type==="image/webp"?"sticker":n.type.split("/")[0];if(n.size&&n.size>i[a])throw new Error(`File is too big (${n.size} bytes) for a ${a} (${i[a]} bytes limit)`)}let r=this.fetch(`https://graph.facebook.com/${this.v}/${e}/media?messaging_product=whatsapp`,{method:"POST",body:t,headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"multipart/form-data"}});return this.getBody(r)}fetchMedia(e){return this._authenicatedRequest(new URL(e))}async deleteMedia(e,t){let s=t?`phone_number_id=${t}`:"",r=this.fetch(`https://graph.facebook.com/${this.v}/${e}?${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${this.token}`}});return this.getBody(r)}async post(e,t,s){if(this.secure){if(!this.appSecret)throw 500;if(!this.subtle)throw 501;if(!t)throw 400;if(s=s?.split("sha256=")[1],!s)throw 401;let o=new TextEncoder,i=o.encode(this.appSecret),a=await this.subtle.importKey("raw",i,{name:"HMAC",hash:"SHA-256"},!0,["sign","verify"]),p=o.encode(t),h=await this.subtle.sign("HMAC",a,p.buffer),c=Array.from(new Uint8Array(h)).map(d=>d.toString(16).padStart(2,"0")).join("");if(s!==c)throw 401}if(!e.object)throw 400;let r=e.entry[0].changes[0].value,n=r.metadata.phone_number_id;if("messages"in r){let o=r.contacts[0],i=o.wa_id,a=o.profile.name,p=r.messages[0],h={phoneID:n,from:i,message:p,name:a,raw:e};this.on.message?.(h)}else if("statuses"in r){let o=r.statuses[0],i=o.recipient_id,a=o.status,p=o.id,h=o.conversation,m=o.pricing,c=o.errors?.[0],d={phoneID:n,phone:i,status:a,id:p,conversation:h,pricing:m,error:c,raw:e};this.on.status?.(d)}return 200}get(e){if(!this.webhookVerifyToken)throw 500;let{"hub.mode":t,"hub.verify_token":s,"hub.challenge":r}=e;if(!t||!s)throw 400;if(t==="subscribe"&&s===this.webhookVerifyToken)return r;throw 403}_authenicatedRequest(e){if(!e)throw new Error("URL must be specified");return this.fetch(e,{headers:{Authorization:`Bearer ${this.token}`}})}async getBody(e){return this.parsed?await(await e).json():e}};export{g as default};
